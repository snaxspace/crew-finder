<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Crew Finder</title>
<meta name="theme-color" content="#d7000f">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" sizes="180x180" href="icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Crew Finder">
<style>
  :root{ --aa-red:#d7000f; --aa-red-dark:#b0000c; --ink:#111; --muted:#666; --border:#e7e7e7; --card:#fff; --bg:#fafafa; }
  *{box-sizing:border-box} html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;line-height:1.35}
  header{position:sticky;top:0;z-index:20;background:var(--aa-red);color:#fff;padding:14px 16px 12px;border-bottom:1px solid rgba(0,0,0,.06)}
  .title{display:flex;align-items:center;gap:10px;justify-content:space-between}
  h1{margin:0;font-size:18px;font-weight:800;letter-spacing:.2px}
  .count{opacity:.9;font-size:13px;font-weight:700}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  input[type="search"]{flex:1;min-width:200px;padding:12px 14px;border-radius:14px;border:0;outline:none;background:#fff;color:#111;font-size:16px}
  .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:10px}
  .chip{padding:6px 10px;border:1px solid #ffd6d9;border-radius:999px;font-size:12px;background:#fff;color:#b0000c;cursor:pointer;user-select:none}
  .wrap{padding:12px 12px 80px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:12px;margin:8px 0;box-shadow:0 1px 0 rgba(0,0,0,.04)}
  .batch{font-size:12px;color:#d34e55;margin-bottom:4px;font-weight:800}
  .name{font-weight:900;font-size:16px;margin:2px 0}
  .meta{font-size:12px;color:var(--muted);margin-bottom:6px;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .rank{display:inline-block;background:#ffe6e8;border:1px solid #ffd1d5;color:#a3000c;font-size:11px;border-radius:999px;padding:3px 8px}
  .lineinfo{font-size:12px;color:#444;margin:6px 0}
  .lineinfo .missing{display:inline-block;background:#f5f5f5;border:1px solid #e8e8e8;color:#777;border-radius:999px;padding:3px 8px;margin-left:6px}
  .notes{font-size:12px;color:#222;margin:8px 0 10px;white-space:pre-wrap}
  .btns{display:flex;gap:8px}
  button{appearance:none;border:0;border-radius:12px;padding:12px 14px;font-size:14px;cursor:pointer}
  .primary{background:#d7000f;color:#fff;font-weight:800}
  .primary:active{background:#b0000c}
  .disabled{background:#f2f2f2;color:#999;border:1px solid #e5e5e5;cursor:not-allowed}
  .footer{position:fixed;bottom:0;left:0;right:0;padding:10px 12px;border-top:1px solid var(--border);background:#fff;display:none;}
  #csvFile{display:none}
</style>
</head>
<body>

<header>
  <div class="title">
    <h1>Crew Finder</h1>
    <span class="count" id="count">(0)</span>
  </div>
  <div class="row">
    <input id="q" type="search" inputmode="search" placeholder="Search batch, name, nickname, staff ID, rank, LINE ID, notes…" autocomplete="off" />
  </div>
  <div class="chips" id="chips"></div>
</header>

<main class="wrap">
  <div id="list"></div>
</main>

<footer class="footer">
  <button class="ghost" id="importCsv">Import CSV</button>
  <button class="ghost" id="help">Help</button>
  <input id="csvFile" type="file" accept=".csv,text/csv" />
</footer>

<script>
const CONFIG = {
  SHEET_CSV_URL: "crew.csv",
  HEADERS: ["Batch","Name","Nickname","Staff_ID","Rank","LINE_ID","Notes"]
};

let CREW = [];

// Elements
const $q = document.getElementById("q");
const $list = document.getElementById("list");
const $count = document.getElementById("count");
const $chips = document.getElementById("chips");
const $importCsv = document.getElementById("importCsv");
const $csvFile = document.getElementById("csvFile");
const $help = document.getElementById("help");

// Helpers
const norm = (s)=> (s||"").toString().toLowerCase();
const tokenize = (s)=> norm(s).split(/[^a-z0-9/ก-๙]+/).filter(Boolean);
const haystack = (c)=> [c.batch,c.name,c.nickname,c.staff_id,c.rank,c.line_id,c.notes].map(norm).join(" ");
const openLineById = (lineId)=>{ const id=(lineId||"").trim(); if(!id) return; location.href = `line://ti/p/~${encodeURIComponent(id)}`; };

function parseCSV(text){
  const rows=[]; let i=0, cur="", inQ=false, row=[];
  const pushCell=()=>{ row.push(cur); cur=""; };
  const pushRow=()=>{ rows.push(row); row=[]; };
  while(i<text.length){
    const ch=text[i++];
    if(inQ){ if(ch=='"'){ if(text[i]=='"'){cur+='"'; i++;} else {inQ=false;} } else {cur+=ch;} }
    else { if(ch=='"') inQ=true; else if(ch==',') pushCell(); else if(ch=='\n'){pushCell(); pushRow();} else if(ch=='\r'){} else cur+=ch; }
  }
  pushCell(); if(row.length>1 || row[0]!="") pushRow();
  return rows;
}

function csvToCrew(text){
  const rows = parseCSV(text.trim());
  if(!rows.length) return [];
  const header = rows[0].map(h=>h.trim());
  const expected = CONFIG.HEADERS;
  const ok = expected.every((h, idx)=> (header[idx]||"").toLowerCase() === h.toLowerCase());
  if(!ok) { alert("CSV headers mismatch. Expected: "+expected.join(", ")+" | Got: "+header.join(", ")); return []; }
  const gi=(n)=> header.findIndex(h=>h.toLowerCase()===n.toLowerCase());
  const iBatch=gi("Batch"), iName=gi("Name"), iNick=gi("Nickname"), iStaff=gi("Staff_ID"), iRank=gi("Rank"), iLine=gi("LINE_ID"), iNotes=gi("Notes");
  const out=[];
  for(let r=1;r<rows.length;r++){ const cells=rows[r]; if(!cells || !cells.length) continue;
    out.push({
      batch:(cells[iBatch]||"").trim(),
      name:(cells[iName]||"").trim(),
      nickname:(cells[iNick]||"").trim(),
      staff_id:(cells[iStaff]||"").trim(),
      rank:(cells[iRank]||"").trim(),
      line_id:(cells[iLine]||"").trim(),
      notes:(cells[iNotes]||"").trim()
    });
  }
  return out;
}

function card(c){
  const el = document.createElement("div");
  el.className = "card";
  const hasId = !!(c.line_id && c.line_id.trim());
  const lineInfo = hasId ? `<span>LINE: ${c.line_id}</span>` : `<span>LINE: —</span><span class="missing">No LINE ID found</span>`;
  el.innerHTML = `
    ${c.batch ? '<div class="batch">Batch '+c.batch+'</div>' : ''}
    <div class="name">${c.name} ${c.nickname ? '• '+c.nickname : ''}</div>
    <div class="meta"><span class="rank">${c.rank || '—'}</span><span>Staff ID: ${c.staff_id || '-'}</span></div>
    <div class="lineinfo">${lineInfo}</div>
    ${c.notes ? '<div class="notes">'+c.notes+'</div>' : ''}
    <div class="btns"><button class="${hasId ? 'primary' : 'disabled'}" ${hasId ? '' : 'disabled'}>${hasId ? 'Chat on LINE' : 'No LINE ID'}</button></div>
  `;
  const btn = el.querySelector("button");
  if (hasId) btn.onclick = ()=> openLineById(c.line_id);
  return el;
}

function matchesQuery(c, q){ if(!q) return true; const tokens=tokenize(q); const hay=haystack(c); return tokens.every(t=> hay.includes(t)); }
function renderList(qstr){
  const results = CREW.filter(c=> matchesQuery(c,qstr));
  const sorted = results.slice().sort((a,b)=> (b.batch||"").localeCompare(a.batch||"", undefined, {numeric:true, sensitivity:"base"}) || (a.name||"").localeCompare(b.name||""));
  $list.innerHTML=""; sorted.forEach(c=> $list.appendChild(card(c))); $count.textContent = `(${sorted.length})`;
}
function renderChips(){
  const batches = Array.from(new Set(CREW.map(c=>c.batch).filter(Boolean)));
  $chips.innerHTML = "";
  batches.slice(0,16).forEach(b=>{ const d=document.createElement("div"); d.className="chip"; d.textContent=b; d.onclick=()=>{ $q.value=b; renderList($q.value.trim()); }; $chips.appendChild(d); });
}

$q.addEventListener("input", ()=> renderList($q.value.trim()));

// Auto-load from local crew.csv on open
(async function init(){
  try{
    const res = await fetch(CONFIG.SHEET_CSV_URL, {cache:"no-cache"});
    if(!res.ok) throw new Error(res.status+" "+res.statusText);
    const text = await res.text();
    const parsed = csvToCrew(text);
    if(parsed.length){ CREW=parsed; renderChips(); renderList(""); }
  }catch(err){
    console.warn("Auto-load failed:", err);
  }
})();
</script>

<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./service-worker.js')
      .catch(err => console.warn('Service Worker failed:', err));
  }
</script>

</body>
</html>
